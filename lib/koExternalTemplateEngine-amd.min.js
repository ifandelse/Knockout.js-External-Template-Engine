define(["knockout","jquery","infuser"],function(ko,jQuery,infuser){var ExternalTemplateSource=function(templateId,options){var self=this,origAfterRender;self.templateId=templateId,self.loaded=!1,self.template=ko.observable(infuser.defaults.useLoadingTemplate?infuser.defaults.loadingTemplate.content:undefined),self.template.data={},self.options=ko.utils.extend({},options),self.options.templateId=templateId,self.options&&self.options.afterRender&&(origAfterRender=self.options.afterRender,self.options.afterRender=function(){self.loaded&&origAfterRender.apply(self.options,arguments)})};ko.utils.extend(ExternalTemplateSource.prototype,{data:function(key,value){if(arguments.length===1)return key==="precompiled"&&this.template(),this.template.data[key];this.template.data[key]=value},text:function(value){this.loaded||this.getTemplate();if(arguments.length===0)return this.template();this.template(arguments[0])},getTemplate:function(){var self=this;infuser.get(self.options,function(tmpl){self.data("precompiled",null),self.template(tmpl),self.loaded=!0})}});var KoExternalTemplateEngine=function(koEngineType){var engine=koEngineType?new koEngineType:new ko.nativeTemplateEngine;return engine.templates={},engine.makeTemplateSource=function(template,bindingContext,options){if(typeof template=="string"){var elem=document.getElementById(template);return elem?new ko.templateSources.domElement(elem):(engine.templates[template]||(engine.templates[template]=new ExternalTemplateSource(template,options)),engine.templates[template])}if(template.nodeType==1||template.nodeType==8)return new ko.templateSources.anonymousTemplate(template)},engine.renderTemplate=function(template,bindingContext,options){var templateSource=engine.makeTemplateSource(template,bindingContext,options);return engine.renderTemplateSource(templateSource,bindingContext,options)},engine};ko.KoExternalTemplateEngine=KoExternalTemplateEngine,jQuery.tmpl&&jQuery.tmpl.tag.tmpl.open.toString().indexOf("__")>=0?ko.setTemplateEngine(new KoExternalTemplateEngine(ko.jqueryTmplTemplateEngine)):ko.setTemplateEngine(new KoExternalTemplateEngine)})